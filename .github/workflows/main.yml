name: Power Playwright

on:
  push:
    branches: [ main ]
  pull_request: 
    branches: [ main ]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      - name: Restore dependencies
        run: dotnet restore
      - name: Build
        run: dotnet build -c Release --no-restore
      - name: Run unit tests
        id: test
        run: dotnet test tests/PowerPlaywright.UnitTests/PowerPlaywright.UnitTests.csproj -c Release --logger console --logger html --no-build --results-directory TestResults
      - name: Upload unit test results
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: TestResults
        if: ${{ always() }}
      - name: Pack
        run: dotnet pack --no-restore --output nupkg
      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: nupkg
          path: nupkg
      - name: Upload integration tests
        uses: actions/upload-artifact@v4
        with:
          name: integration-tests
          path: tests/PowerPlaywright.IntegrationTests/bin/Release/net8.0
          include-hidden-files: true
  test:
    runs-on: windows-latest
    needs: build
    steps:
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x
      - name: Download integration tests
        uses: actions/download-artifact@v4
        with:
          name: integration-tests
          path: integration-tests
      - name: Setup Playwright
        run: integration-tests/playwright.ps1 install chromium --with-deps
        shell: pwsh
      - name: Run integration tests
        run: dotnet test integration-tests/PowerPlaywright.IntegrationTests.dll --results-directory TestResults -- MSTest.Parallelize.Workers=4 Playwright.LaunchOptions.Headless=true
      - name: Upload integration test results
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: TestResults
        if: ${{ always() }}